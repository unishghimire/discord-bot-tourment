<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eSports Manager Bot Dashboard</title>
    <style>
        :root { --discord-blurple: #5865F2; --discord-dark: #313338; --discord-black: #1E1F22; --success: #23A559; --danger: #F23F43; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--discord-black); color: #DBDEE1; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .app-container { width: 100%; max-width: 900px; }
        .card { background: var(--discord-dark); border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #444; }
        h1, h2, h3 { color: white; margin-top: 0; }
        .status-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .indicator { width: 12px; height: 12px; border-radius: 50%; background: var(--danger); }
        .indicator.online { background: var(--success); box-shadow: 0 0 10px var(--success); }
        input { background: #1E1F22; border: 1px solid #444; color: white; padding: 12px; border-radius: 4px; width: 100%; box-sizing: border-box; margin-bottom: 10px; font-family: monospace; }
        .btn-group { display: flex; gap: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--discord-blurple); }
        .btn-primary:hover { background: #4752C4; }
        .btn-sync { background: #EB459E; }
        #console { background: #000; color: #00FF00; padding: 15px; border-radius: 5px; height: 300px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 13px; line-height: 1.5; }
        .match-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #444; }
        code { background: #2b2d31; padding: 2px 5px; border-radius: 4px; color: #00A8FC; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="card">
        <h1>üèÜ eSports Tournament Bot</h1>
        <div class="status-bar">
            <div id="status-indicator" class="indicator"></div>
            <span id="status-text">Bot is Offline</span>
        </div>

        <label>Bot Token</label>
        <input type="password" id="botToken" value="MTQ2NDUyMTA2OTgwODQ1NTc4NQ.Gf0ElM.eCKEGOykDTdX6VwApcuAXQjZovhAs9Rh7Chy3E">
        
        <label>Client (Application) ID</label>
        <input type="text" id="clientId" value="1464521069808455785">

        <div class="btn-group">
            <button class="btn-primary" onclick="startBot()">Connect Bot</button>
            <button class="btn-sync" onclick="syncSlashCommands()">Sync / Commands</button>
        </div>
    </div>

    <div class="card">
        <h3>Live Tournament Control</h3>
        <div id="tourney-status">No active tournament session.</div>
        <div id="match-list"></div>
    </div>

    <div class="card">
        <h3>System Logs</h3>
        <div id="console"></div>
    </div>
</div>

<script>
    let socket;
    let tournament = { name: "None", teams: [], matches: [], status: 'Idle' };
    const proxy = "https://api.allorigins.win/raw?url=";

    function log(msg, color = "#00FF00") {
        const consoleEl = document.getElementById('console');
        const time = new Date().toLocaleTimeString();
        consoleEl.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
        consoleEl.scrollTop = consoleEl.scrollHeight;
    }

    // --- SLASH COMMAND SYNC ---
    async function syncSlashCommands() {
        const token = document.getElementById('botToken').value;
        const appId = document.getElementById('clientId').value;
        
        const commands = [
            { name: "create", description: "Start a new tournament", options: [{ name: "name", description: "Name of the event", type: 3, required: true }] },
            { name: "join", description: "Register your team", options: [{ name: "team", description: "Team Name", type: 3, required: true }] },
            { name: "start", description: "Generate the bracket and start matches" },
            { name: "status", description: "Check current teams and matches" }
        ];

        log("Attempting to sync slash commands...", "#00A8FC");
        
        try {
            // Using a direct fetch first, if CORS fails, use the console hack instructions
            const response = await fetch(`${proxy}${encodeURIComponent(`https://discord.com/api/v10/applications/${appId}/commands`)}`, {
                method: 'PUT',
                headers: { 
                    'Authorization': `Bot ${token}`, 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify(commands)
            });

            if(response.ok) {
                log("‚úÖ Slash Commands Synced! Restart your Discord client to see them.", "var(--success)");
            } else {
                const err = await response.json();
                log("‚ùå Sync Error: " + JSON.stringify(err), "var(--danger)");
                log("Note: If you see 'Internal Network Error', copy-paste the sync code into the Discord Web Console.", "#FFCC00");
            }
        } catch (e) {
            log("Fetch Error: " + e.message, "var(--danger)");
        }
    }

    // --- BOT CONNECTION ---
    function startBot() {
        const token = document.getElementById('botToken').value;
        
        socket = new WebSocket("wss://gateway.discord.gg/?v=10&encoding=json");

        socket.onopen = () => log("Gateway connection established. Authenticating...");

        socket.onmessage = async (event) => {
            const data = JSON.parse(event.data);
            const { op, t, d } = data;

            if (op === 10) { // Hello
                setInterval(() => socket.send(JSON.stringify({ op: 1, d: null })), d.heartbeat_interval);
                socket.send(JSON.stringify({
                    op: 2,
                    d: {
                        token: token,
                        intents: 0, // Slash commands don't need intents
                        properties: { $os: "linux", $browser: "chrome", $device: "pc" }
                    }
                }));
            }

            if (t === "READY") {
                document.getElementById('status-indicator').className = "indicator online";
                document.getElementById('status-text').innerText = `Online as ${d.user.username}`;
                log(`Connected as ${d.user.username}#${d.user.discriminator}`, "var(--success)");
            }

            if (t === "INTERACTION_CREATE") {
                handleInteraction(d, token);
            }
        };

        socket.onclose = () => {
            document.getElementById('status-indicator').className = "indicator";
            document.getElementById('status-text').innerText = "Bot is Offline";
            log("Disconnected from Discord.", "var(--danger)");
        };
    }

    // --- COMMAND LOGIC ---
    async function handleInteraction(i, token) {
        const { name, options } = i.data;
        let reply = "";

        log(`Received Command: /${name}`, "#EB459E");

        if (name === "create") {
            const n = options[0].value;
            tournament = { name: n, teams: [], matches: [], status: 'Registration Open' };
            reply = `üèÜ **Tournament Created: ${n}**\nTeams can now join using \`/join [TeamName]\``;
        }

        else if (name === "join") {
            if (tournament.status === 'Idle') {
                reply = "‚ùå No active tournament. Use `/create` first.";
            } else {
                const teamName = options[0].value;
                tournament.teams.push({ name: teamName, captain: i.member.user.username });
                reply = `‚úÖ **Team ${teamName}** has entered the battle! (${tournament.teams.length} teams total)`;
            }
        }

        else if (name === "start") {
            if (tournament.teams.length < 2) {
                reply = "‚ùå Need at least 2 teams to generate a bracket!";
            } else {
                tournament.status = "In Progress";
                tournament.matches = [];
                for (let j = 0; j < tournament.teams.length; j += 2) {
                    if (tournament.teams[j+1]) {
                        tournament.matches.push(`${tournament.teams[j].name} vs ${tournament.teams[j+1].name}`);
                    }
                }
                reply = `üöÄ **Tournament Started!**\n**Round 1 Matches:**\n${tournament.matches.join('\n')}`;
            }
        }

        else if (name === "status") {
            reply = `üìä **Tournament:** ${tournament.name}\n**Status:** ${tournament.status}\n**Teams (${tournament.teams.length}):** ${tournament.teams.map(t => t.name).join(', ') || 'None'}`;
        }

        // Send response back to Discord
        await fetch(`https://discord.com/api/v10/interactions/${i.id}/${i.token}/callback`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 4, data: { content: reply } })
        });

        updateDashboard();
    }

    function updateDashboard() {
        document.getElementById('tourney-status').innerHTML = `
            <strong>Active Event:</strong> ${tournament.name} <br>
            <strong>Status:</strong> ${tournament.status} <br>
            <strong>Teams:</strong> ${tournament.teams.length}
        `;
        
        const matchList = document.getElementById('match-list');
        matchList.innerHTML = tournament.matches.map(m => `<div class="match-row"><span>${m}</span> <span style="color:var(--success)">LIVE</span></div>`).join('');
    }
</script>

</body>
</html>
